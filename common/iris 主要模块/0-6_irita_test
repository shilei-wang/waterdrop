
=====================================================================================================================
=====================================================================================================================
======    wasm (WebAssembly)====================================================================================================
=====================================================================================================================
=====================================================================================================================
https://github.com/bianjieai/irita/tree/vincent-sequence/modules/wasm


---
1. Compile smart contract
---
# install wasm-pack  //需要翻墙 curl www.google.com
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# clone example
cd /Users/sherlock/go/src/github.com/
mkdir confio
cd confio
git clone https://github.com/confio/cosmwasm-examples
cd cosmwasm-examples/escrow
git checkout escrow-0.2.1

# 需要安装更新 node ， rust
brew install node 或者 brew upgrade node

brew install rustup-init
rustup update
rustc --version
rustc 1.41.0 (5e1a79984 2020-01-27)

# complie  //需要翻墙 curl www.google.com
wasm-pack build
du -h ./pkg/cw_escrow_bg.wasm

# cp wasm to work dir
mkdir ~/wasm-test
cp ./pkg/cw_escrow_bg.wasm ~/wasm-test/contract.wasm

---
2. Init testnet
---
cd ~/wasm-test
irita testnet --v 1 --chain-id test
irita start --home mytestnet/node0/irita


---
3. deploy the contract
---
# add key node1
iritacli keys add node1

# both should be empty
iritacli query wasm list-code
iritacli query wasm list-contracts

# upload and see we create code 1
# gas is huge due to wasm size... but auto-zipping reduced this from 800k to around 260k
iritacli tx wasm store contract.wasm --gas 3000000 --from node0  -y -b block --chain-id test
iritacli query wasm list-code

---
4. Instantiating the contract
---
# instantiate contract and verify
INIT="{\"arbiter\":\"$(iritacli keys show node0 -a)\", \"recipient\":\"$(iritacli keys show node1 -a)\", \"end_time\":0, \"end_height\":0}"

//实例化
iritacli tx wasm instantiate 1 "$INIT" --from node0 --amount=50000stake -y -b block --chain-id test

# check the contract state (and account balance)
iritacli query wasm list-contracts
iritacli query wasm contract <contract-id>
iritacli query account <contract-id>


iritacli query wasm list-contracts
iritacli query wasm contract faa18vd8fpwxzck93qlwghaj6arh4p7c5n89307smc
iritacli query account faa18vd8fpwxzck93qlwghaj6arh4p7c5n89307smc


=====================================================================================================================
=====================================================================================================================
======      NFT  ====================================================================================================
=====================================================================================================================
=====================================================================================================================
https://gitlab.bianjie.ai/irita/spec/blob/v1.0/nft/README.md

iritacli keys show v0


iritacli tx nft mint -h


//tx mint
iritacli tx nft mint d01 a01 --recipient=iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp --token-uri="tokenURI"  --from=v0 --chain-id=shilei-qa --fees=4stake -b block -y

iritacli tx nft mint d01 a02 --recipient=iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp --token-uri="tokenURI"  --from=v0 --chain-id=shilei-qa --fees=4stake -b block -y

iritacli tx nft mint d02 a01 --recipient=iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp --token-uri="tokenURI"  --from=v0 --chain-id=shilei-qa --fees=4stake -b block -y


**** 查询 ****
//demon:d02 下的nft supply总数
iritacli query nft supply d01

//iritacli query nft owner [accountAddress] [denom](optional)
iritacli query nft owner iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp

//collection
iritacli query nft collection d01

//query denoms
iritacli query nft denoms

//query nft
iritacli query nft token d01 a01

**** **** ****

iritacli query nft token d01 a01
//edit ， 必须要用owner
iritacli keys add v1 --recover
caught below output final blast sun elevator labor regular palm dizzy stand arctic judge cost typical confirm people dust panic still aspect sword save
iritacli tx send v0 iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp 10000stake --chain-id=shilei-qa --fees=4stake -b block -y

iritacli tx nft edit d01 a01 --token-uri="tokenURI2" --from=v1 --chain-id=shilei-qa --fees=4stake -b block -y

iritacli query nft token d01 a01


//tx transfer
iritacli tx nft transfer -h

iritacli keys show v0
// iaa13l2sgxymaq3emnpftks2e8xz5df9q7c0vsz04v

iritacli tx nft transfer iaa13l2sgxymaq3emnpftks2e8xz5df9q7c0vsz04v d01 a01 --from=v1 --chain-id=shilei-qa --fees=4stake -b block -y

iritacli query nft token d01 a01

//tx burn
iritacli tx nft burn d01 a01 --from=v0 --chain-id=shilei-qa --fees=4stake -b block -y

iritacli query nft collection d01



========================================================================================================================
========================================================================================================================
==================guardian======================================================================================================
========================================================================================================================
========================================================================================================================

iritacli keys show v0
在genesis里面搜索profiler手动添加

iritacli tx guardian add-profiler --from=v0 --address=faa1lcuw6ewd2gfxap37sejewmta205sgssmv5fnju --description=aa --chain-id=shilei-qa --fees=4stake -b block -y
iritacli tx guardian add-trustee --from=v0 --address=faa1lcuw6ewd2gfxap37sejewmta205sgssmv5fnju --description=aa --chain-id=shilei-qa --fees=4stake -b block -y

iritacli query guardian profilers
iritacli query guardian trustees

iritacli tx guardian delete-profiler --from=v0 --address=faa1lcuw6ewd2gfxap37sejewmta205sgssmv5fnju --chain-id=shilei-qa --fees=4stake -b block -y
iritacli tx guardian delete-trustee --from=v0 --address=faa1lcuw6ewd2gfxap37sejewmta205sgssmv5fnju --chain-id=shilei-qa --fees=4stake -b block -y

iritacli query guardian profilers
iritacli query guardian trustees




========================================================================================================================
========================================================================================================================
==================service======================================================================================================
========================================================================================================================
========================================================================================================================

     ===========================
                定义
     ===========================
1. 服务定义
iritacli tx service define --chain-id=shilei-qa --from=v0 --description=service-description --author-description=author-description --tags=tag1,tag2 --schemas=/Users/sherlock/my_workspace/service/schemas.json --name=a001 --fees=4point -b block -y

2. 服务定义查询 （可以查询 method id）
iritacli query service definition a001

3. 查询 schema
iritacli query service schema pricing
iritacli query service schema result

     ===========================
                绑定
     ===========================
3. 服务绑定
iritacli tx service bind --chain-id=shilei-qa --fees=4point -b block -y --from=v0 --deposit=20000point --min-resp-time=5 --pricing=/Users/sherlock/my_workspace/service/pricing.json --service-name=a001

4. 查询服务绑定
iritacli query service binding a001 $(iritacli keys show v0 --address)
iritacli query service bindings a001


5. 更新绑定 --min-resp-time也可以改
iritacli tx service update-binding a001 --chain-id=shilei-qa --from=v0 --fees=4point -b block -y --deposit=2point --pricing=/Users/sherlock/my_workspace/service/pricing.json --min-resp-time=5

6. 设置提取地址
iritacli tx service set-withdraw-addr --chain-id=shilei-qa --from=v0 --fees=4point -b block -y iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp

//查询提取地址
iritacli query service withdraw-addr $(iritacli keys show v0 --address)

7.服务失效
iritacli tx service disable a001 --chain-id=shilei-qa --from=v0 --fees=4point -b block -y

8.服务恢复 ，可以增加抵押
iritacli tx service enable a001 --chain-id=shilei-qa --from=v0 --fees=4point -b block -y --deposit=1point

9. 取回抵押 (滞后 COMPLAINT_RETROSPECT (Gov) + ARBITRATION_TIMELIMIT (Gov)) 、、这个还没有测
iritacli tx service refund-deposit a001 --chain-id=shilei-qa --from=v0 --fees=4point -b block -y

     ===========================
      service 调用
     ===========================

1. 服务调用
1）批量请求
//单个
iritacli tx service call --chain-id=shilei-qa --from=v0 --fees=4point -b block -y --service-name=a001  --timeout=20 --service-fee-cap=1point --data="{\"id\": \"1234\",\"name\": \"bianjie\",\"data\": \"facedata\"}" --providers=$(iritacli keys show v0 --address)

//重复
iritacli tx service call --chain-id=shilei-qa --from=v0 --fees=4point -b block -y --service-name=a001 --service-fee-cap=1point --data="{\"id\": \"1234\",\"name\": \"bianjie\",\"data\": \"facedata\"}" --providers=$(iritacli keys show v0 --address) --timeout=20 --repeated --frequency=20 --total=-1


查询请求列表
//如果查不到 可能是price低了，可能是min-resp-time没满足bind
iritacli query service requests a001 $(iritacli keys show v0 --address) -o=json


根据上一条返回的id
iritacli query service request 60C9694FA039371704024228DD21696BDED38241FF7CA5F8B2418F5484B120CA0000000000000000000000000000000100000000000000280000

//用<request-context-id>超时后可以查到
iritacli query service requests 49AABDEA5C87845479947FD7C0CCD5B6F210AC3A885D21E092AD20115997ECA10000000000000000 1 -o=json
iritacli query service request-context 49AABDEA5C87845479947FD7C0CCD5B6F210AC3A885D21E092AD20115997ECA10000000000000000


3.相应请求
iritacli tx service respond --chain-id=shilei-qa --from=v0  --fees=4point -b block -y  --data="{\"data\": \"userdata\"}" --result='{"code":200,"message":"it500"}' --request-id=$(iritacli query service requests a001 $(iritacli keys show v0 --address) -o=json | jq -r .[0].id)

4.查询相应请求 ，用"3）"返回request id
iritacli query service response -o=json C2FFBF8A2018050B49FFC607688942442127A9BF78BEA91B0B40A5D90596D5A30000000000000000000000000000000100000000000000900000

     ===========================
       取回服务调用产生的服务费（卖家），未响应超时的服务费会自动退还给（买家）
     ===========================
1.查询服务费
iritacli query service fees $(iritacli keys show v0 --address)


2.提取服务调用产生的服务费
iritacli tx service withdraw-fees --chain-id=shilei-qa --from=v0 --fees=4point -b block -y
// iritacli query account iaa1lcuw6ewd2gfxap37sejewmta205sgssm5m0tjp

3.注意 irita 没有 withdraw-tax

     ===========================
      请求上下文相关 ====》》》  测下 nftlcd 的bug 下载一个新的
     ===========================
1. 查询请求上下文 <request-context-id>， 返回这个call的很多字段信息
iritacli query service request-context E59652EEB5E6B8C5FECDF87F2D7EB1852E357410D999D99B1B99EF45A73865120000000000000000
//查询request id
iritacli query service requests a001 $(iritacli keys show v0 --address) -o=json

2. 暂停请求上下文
iritacli tx service pause --chain-id=shilei-qa --from=v0  --fees=4point -b block -y E59652EEB5E6B8C5FECDF87F2D7EB1852E357410D999D99B1B99EF45A73865120000000000000000

3. 启动请求上下文
//state变成running , BatchState在complete状态也会变running
iritacli tx service start --chain-id=shilei-qa --from=v0 --fees=4point -b block -y E59652EEB5E6B8C5FECDF87F2D7EB1852E357410D999D99B1B99EF45A73865120000000000000000

4. 更新请求上下文
iritacli tx service update --chain-id=shilei-qa --from=v0 --fees=4point -b block -y  --frequency=22 --total=3000 E59652EEB5E6B8C5FECDF87F2D7EB1852E357410D999D99B1B99EF45A73865120000000000000000

5. 终止请求上下文
// state变成complete
// 非repeated 不能kill
echo 1234567890 | iriscli service kill --chain-id=shilei-qa --from=v0 --fee=0.004iris --commit  D1CA04D63DB06F373606ECD4AEBDB4287455358D0117806C2BF886669BCD47B60000000000000000

6. 查询请求上下文的请求列表 （注意价格不到的请求是会被过滤掉）
//列表只有有效的才会被查出， 但是iriscli service request-context 永远能查出）
iritacli query service request-context E59652EEB5E6B8C5FECDF87F2D7EB1852E357410D999D99B1B99EF45A73865120000000000000000

7. 查询请求上下文的响应列表（后面是request id）
//注意这个只能查活跃的 ， 过期的查不到。
iritacli query service response 69914805ee50573828580f941e92a852dfd0ee62d4f0f5e77deff111e414d1cb00000000000000420000
iritacli query service responses <request-context-id> <batch-counter>

